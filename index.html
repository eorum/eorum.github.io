<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="rating" content="safe for kids">
  <meta name="description" content="Pretend it's nothing.">
  <link rel="canonical" href="https://eorum.org/">
  <meta name="theme-color" content="black">
  <link rel="stylesheet" href="css/bulma.min.css">
  <title>Eorum â€“ It's theirs</title>
  <style>
    html {
      background-color: black;
      scroll-padding-top: 3.25rem;
      scroll-behavior: smooth;
      hyphens: auto;
    }

    body {
      font-family: sans-serif;
      color: hsl(0, 0%, 21%);
    }

    section {
      background-color: hsl(0, 0%, 92%);
      padding: 1rem;
    }

    section:not(:first-of-type) {
      margin-top: 0.25rem;
    }

  </style>
</head>
<body class="has-navbar-fixed-top">
  <nav class="navbar is-fixed-top is-black" aria-label="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-home navbar-item is-size-4 pl-4" href="#">
          <img src="icons/logo-black.svg" alt="" style="width: auto; height: 1.5rem;">
          <h1 class="ml-3">
            Eorum
          </h1>
        </a>
        <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
          <span class="inactive" aria-hidden="true"></span>
          <span class="inactive" aria-hidden="true"></span>
          <span class="inactive" aria-hidden="true"></span>
        </a>
      </div>

      <div class="navbar-menu">
        <div class="navbar-start"></div>
      </div>
    </div>
  </nav>
  
  <section id="eorum">
    <div class="field has-addons">
      <input id="eorumInput" class="input" type="email" value="info@eorum.org">
      <button id="eorumButton" class="button">Resolve</button>
    </div>
    </div>
  </section>

  <section id="dns">
    <div class="container">
      <h2 class="title">
        Server
      </h2>
      <div class="field has-addons">
        <input id="dnsInput" class="input" type="text" size="40">
        <button id="dnsButton" class="button">Request</button>
      </div>
    </div>
  </section>

  <section id="result">
    <div class="container">
      <h2 class="title">
        Result
      </h2>

      <pre id="resultText"></pre>
    </div>
  </section>

  <section id="log">
    <div class="container">
      <h2 class="title">
        Log
      </h2>

      <pre id="logText"></pre>
    </div>
  </section>

  <script>
    'use strict;'

    const e = {
      eorum: {
        input: document.getElementById('eorumInput'),
        button: document.getElementById("eorumButton"),
      },
      dns: {
        input: document.getElementById("dnsInput"),
        button: document.getElementById("dnsButton")
      },
      result: {
        text: document.getElementById("resultText")
      },
      log: {
        text: document.getElementById('logText')
      }
    };

    async function resolveDNS(address) {
      const [user, domain] = address.split("@");
      const params = new URLSearchParams({
        name: "_eorum._tcp." + domain,
        type: "SRV"
      });

      const url = "https://cloudflare-dns.com/dns-query?" + params.toString();
      const response = await fetch(url, {
        headers: {
          accept: "application/dns-json"
        }
      });

      if (!response.ok || response.status != 200)
        throw response.status;

      const reply = await response.json();
      if (reply.Status === 0) {
        const [prio, weight, port, target] = reply.Answer[0].data.split(' ');
        return 'https://' + target + (port != 443 ? ':' + port : '') + '/' + address;

      } else
        throw String(reply.Status);
    }

    async function resolveEorum(url) {
      const response = await fetch(url, {
        headers: {
          accept: "application/json"
        }
      });

      if (!response.ok || response.status != 200)
        throw response.status;

      const reply = await response.json();
      return JSON.stringify(reply, null, 2);
    }

    const log = (text) => {
      const div = document.createElement('div');
      div.innerHTML = text;
      e.log.text.appendChild(div);

      while (e.log.text.childElementCount > 10)
        e.log.text.firstChild.remove();
    }

    e.eorum.button.addEventListener('click', () => {
      if (!e.eorum.input.value)
        return;

      log("DNS query");
      e.dns.input.value = '';
      e.result.text.innerHTML = '';

      resolveDNS(e.eorum.input.value)
        .then((result) => {
          e.dns.input.value = result;
          log("DNS reply");
        })
        .catch((error) => {
          log("DNS error: " + error);
        })
    });

    e.dns.button.addEventListener('click', () => {
      if (!e.dns.input.value)
        return;

      log("Eorum query");
      e.result.text.innerHTML = '';

      resolveEorum(e.dns.input.value)
        .then((result) => {
          e.result.text.innerHTML = result;
          log("Eorum reply");
        })
        .catch((error) => {
          log("Eorum error: " + error);
        })
    });

    {
      const url = new URL(window.location);
      const their = url.searchParams.get('their');
      if (their)
        e.eorum.input.value = their;
    }
  </script>
</body>
</html>
